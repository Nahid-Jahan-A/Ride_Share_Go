# RideShareGo - SaaS Ride-Sharing Platform Architecture

## Executive Summary

RideShareGo is a white-label, multi-tenant SaaS ride-sharing platform designed to be licensed to taxi companies. The platform consists of mobile apps (Passenger & Driver), a web-based Dispatcher Dashboard, Admin Panel, and a flexible backend architecture that starts with Firebase but can migrate to custom backends.

---

## Table of Contents

1. [System Overview](#1-system-overview)
2. [Passenger App Features](#2-passenger-app-features)
3. [Driver App Features](#3-driver-app-features)
4. [Dispatcher Dashboard](#4-dispatcher-dashboard)
5. [Admin Panel Features](#5-admin-panel-features)
6. [Technical Architecture](#6-technical-architecture)
7. [Real-Time GPS & Socket Architecture](#7-real-time-gps--socket-architecture)
8. [Trip Pricing Engine](#8-trip-pricing-engine)
9. [Route Optimization](#9-route-optimization)
10. [Wallet System](#10-wallet-system)
11. [Review & Rating Module](#11-review--rating-module)
12. [Fleet Management](#12-fleet-management)
13. [Database Schema](#13-database-schema)
14. [API Design](#14-api-design)
15. [Microservice Architecture](#15-microservice-architecture)
16. [SaaS Pricing Model](#16-saas-pricing-model)
17. [Flutter Clean Architecture](#17-flutter-clean-architecture)
18. [Backend Abstraction Layer](#18-backend-abstraction-layer)

---

## 1. System Overview

### High-Level Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT LAYER                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Passenger    â”‚    Driver     â”‚  Dispatcher   â”‚    Admin      â”‚   Tenant    â”‚
â”‚  Mobile App   â”‚  Mobile App   â”‚   Dashboard   â”‚    Panel      â”‚   Portal    â”‚
â”‚  (Flutter)    â”‚  (Flutter)    â”‚  (Flutter Web)â”‚ (Flutter Web) â”‚ (Flutter)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚               â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚     API GATEWAY       â”‚
                            â”‚  (Authentication,     â”‚
                            â”‚   Rate Limiting,      â”‚
                            â”‚   Tenant Routing)     â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MICROSERVICES LAYER                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Auth   â”‚   Trip   â”‚ Pricing  â”‚  Route   â”‚  Wallet  â”‚  Rating  â”‚    Fleet    â”‚
â”‚ Service  â”‚ Service  â”‚ Service  â”‚ Service  â”‚ Service  â”‚ Service  â”‚   Service   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Location â”‚  Notify  â”‚ Payment  â”‚ Analyticsâ”‚  Tenant  â”‚   SaaS   â”‚   Promo     â”‚
â”‚ Service  â”‚ Service  â”‚ Service  â”‚ Service  â”‚ Service  â”‚ Billing  â”‚   Service   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DATA LAYER                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Firestore    â”‚     Redis       â”‚   PostgreSQL    â”‚     Elasticsearch       â”‚
â”‚   (Primary DB)  â”‚  (Cache/Pub-Sub)â”‚  (Future Scale) â”‚    (Search/Analytics)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Multi-Tenant Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SAAS PLATFORM (RideShareGo)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Tenant A   â”‚  â”‚  Tenant B   â”‚  â”‚  Tenant C   â”‚   ...       â”‚
â”‚  â”‚ (City Taxi) â”‚  â”‚(Metro Cabs) â”‚  â”‚(Quick Ride) â”‚             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”‚ â€¢ Branding  â”‚  â”‚ â€¢ Branding  â”‚  â”‚ â€¢ Branding  â”‚             â”‚
â”‚  â”‚ â€¢ Config    â”‚  â”‚ â€¢ Config    â”‚  â”‚ â€¢ Config    â”‚             â”‚
â”‚  â”‚ â€¢ Drivers   â”‚  â”‚ â€¢ Drivers   â”‚  â”‚ â€¢ Drivers   â”‚             â”‚
â”‚  â”‚ â€¢ Passengersâ”‚  â”‚ â€¢ Passengersâ”‚  â”‚ â€¢ Passengersâ”‚             â”‚
â”‚  â”‚ â€¢ Fleet     â”‚  â”‚ â€¢ Fleet     â”‚  â”‚ â€¢ Fleet     â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Passenger App Features

### Core Features

| Feature | Description |
|---------|-------------|
| **Onboarding** | Phone/Email registration, OTP verification, profile setup |
| **Ride Booking** | Pick-up/drop-off selection, vehicle type choice, fare estimate |
| **Real-Time Tracking** | Live driver location, ETA updates, route visualization |
| **In-App Payments** | Card, wallet, cash options with receipts |
| **Ride History** | Past trips, receipts, re-book previous trips |
| **Favorites** | Saved locations (Home, Work, etc.) |
| **Scheduled Rides** | Book rides in advance |
| **Split Fare** | Share ride cost with other passengers |
| **Safety Features** | Emergency SOS, share ride details, trusted contacts |
| **Promotions** | Promo codes, referral program, loyalty points |
| **Support** | In-app chat, FAQ, call support |
| **Multi-Language** | Internationalization support |

### Passenger App User Flows

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PASSENGER BOOKING FLOW                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Enter  â”‚â”€â”€â”€â–¶â”‚ Select  â”‚â”€â”€â”€â–¶â”‚  View   â”‚â”€â”€â”€â–¶â”‚ Confirm â”‚       â”‚
â”‚  â”‚Location â”‚    â”‚ Vehicle â”‚    â”‚  Fare   â”‚    â”‚ Booking â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚                                                     â”‚            â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Finding â”‚â”€â”€â”€â–¶â”‚ Driver  â”‚â”€â”€â”€â–¶â”‚ Track   â”‚â”€â”€â”€â–¶â”‚  Trip   â”‚       â”‚
â”‚  â”‚ Driver  â”‚    â”‚ Matched â”‚    â”‚  Ride   â”‚    â”‚Complete â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚                                                     â”‚            â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚  â”‚  Rate   â”‚â”€â”€â”€â–¶â”‚ Payment â”‚                                     â”‚
â”‚  â”‚ Driver  â”‚    â”‚Complete â”‚                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Feature Module Breakdown

```
passenger_app/
â”œâ”€â”€ auth/                    # Authentication module
â”‚   â”œâ”€â”€ login/
â”‚   â”œâ”€â”€ register/
â”‚   â”œâ”€â”€ verify_otp/
â”‚   â””â”€â”€ forgot_password/
â”œâ”€â”€ home/                    # Main booking screen
â”‚   â”œâ”€â”€ location_picker/
â”‚   â”œâ”€â”€ vehicle_selector/
â”‚   â””â”€â”€ fare_estimator/
â”œâ”€â”€ booking/                 # Booking management
â”‚   â”œâ”€â”€ find_driver/
â”‚   â”œâ”€â”€ driver_matched/
â”‚   â”œâ”€â”€ trip_tracking/
â”‚   â””â”€â”€ trip_complete/
â”œâ”€â”€ history/                 # Ride history
â”œâ”€â”€ wallet/                  # Payment & wallet
â”œâ”€â”€ profile/                 # User profile
â”œâ”€â”€ promotions/              # Coupons & offers
â”œâ”€â”€ safety/                  # SOS & safety features
â””â”€â”€ settings/                # App settings
```

---

## 3. Driver App Features

### Core Features

| Feature | Description |
|---------|-------------|
| **Registration** | Multi-step verification: license, vehicle docs, background check |
| **Online/Offline Toggle** | Control availability status |
| **Trip Requests** | Accept/reject with timer, trip details preview |
| **Navigation** | Turn-by-turn navigation, optimized routes |
| **Earnings Dashboard** | Daily/weekly/monthly earnings, trip breakdown |
| **Trip Management** | Start trip, complete trip, cancel with reason |
| **Heat Maps** | High-demand areas visualization |
| **Documents** | Upload/manage required documents |
| **Ratings** | View passenger ratings before accepting |
| **Support** | In-app help, report issues |
| **Incentives** | View active bonuses, targets, achievements |
| **Cash Collection** | Record cash trips, settle with company |

### Driver App User Flows

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DRIVER TRIP FLOW                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Go     â”‚â”€â”€â”€â–¶â”‚ Receive â”‚â”€â”€â”€â–¶â”‚ Accept/ â”‚â”€â”€â”€â–¶â”‚Navigate â”‚       â”‚
â”‚  â”‚ Online  â”‚    â”‚ Request â”‚    â”‚ Decline â”‚    â”‚to Pickupâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚                                                     â”‚            â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Arrive  â”‚â”€â”€â”€â–¶â”‚  Start  â”‚â”€â”€â”€â–¶â”‚Navigate â”‚â”€â”€â”€â–¶â”‚ Arrive  â”‚       â”‚
â”‚  â”‚at Pickupâ”‚    â”‚  Trip   â”‚    â”‚to Drop  â”‚    â”‚at Drop  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚                                                     â”‚            â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚Complete â”‚â”€â”€â”€â–¶â”‚ Collect â”‚â”€â”€â”€â–¶â”‚  Rate   â”‚                      â”‚
â”‚  â”‚  Trip   â”‚    â”‚ Payment â”‚    â”‚Passengerâ”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Driver Status State Machine

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   OFFLINE   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Go Online
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   ONLINE    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
          â”‚                â”‚ Receive Request â”‚
          â”‚                â–¼                 â”‚
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
          â”‚         â”‚  REQUESTED  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Decline/Timeout
          â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
          â”‚                â”‚ Accept          â”‚
          â”‚                â–¼                 â”‚
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
          â”‚         â”‚ EN_ROUTE_   â”‚          â”‚
          â”‚         â”‚   PICKUP    â”‚          â”‚
          â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
          â”‚                â”‚ Arrived         â”‚
          â”‚                â–¼                 â”‚
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
          â”‚         â”‚   WAITING   â”‚          â”‚
          â”‚         â”‚ AT_PICKUP   â”‚          â”‚
          â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
          â”‚                â”‚ Start Trip      â”‚
          â”‚                â–¼                 â”‚
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
          â”‚         â”‚  ON_TRIP    â”‚          â”‚
          â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
          â”‚                â”‚ Complete        â”‚
          â”‚                â–¼                 â”‚
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ COMPLETING  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Dispatcher Dashboard

### Overview

Web-based real-time monitoring and management interface for taxi company operators.

### Features

| Module | Features |
|--------|----------|
| **Live Map** | Real-time view of all drivers, ongoing trips, heat maps |
| **Trip Management** | Manual dispatch, reassign drivers, cancel trips |
| **Driver Management** | Online/offline status, approve new drivers, suspend drivers |
| **Booking Queue** | View pending bookings, manual assignment |
| **Reports** | Daily summaries, revenue reports, driver performance |
| **Alerts** | SOS alerts, long wait times, cancellation spikes |
| **Communication** | Broadcast messages, individual driver messaging |
| **Scheduled Rides** | View and manage future bookings |
| **Customer Support** | Handle passenger complaints, refund requests |

### Dashboard Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RideShareGo Dispatcher Dashboard                    [Notifications] [User] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  Menu   â”‚  â”‚                         LIVE MAP                              â”‚â”‚
â”‚         â”‚  â”‚    [Driver Icons] [Trip Routes] [Heat Zones]                  â”‚â”‚
â”‚ â–¡ Live  â”‚  â”‚                                                                â”‚â”‚
â”‚   Map   â”‚  â”‚    ğŸš— ğŸš—    ğŸš•         ğŸš—                                      â”‚â”‚
â”‚         â”‚  â”‚         ğŸš•        ğŸš—        ğŸš•                                 â”‚â”‚
â”‚ â–¡ Trips â”‚  â”‚                  ğŸš—    ğŸš•                                      â”‚â”‚
â”‚         â”‚  â”‚                                                                â”‚â”‚
â”‚ â–¡ Driverâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â–¡ Fleet â”‚  â”‚    ACTIVE TRIPS         â”‚ â”‚      DRIVER STATUS                â”‚â”‚
â”‚         â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚â”‚
â”‚ â–¡ Reportâ”‚  â”‚ Trip #1234 - En Route   â”‚ â”‚  Online: 45  Busy: 23             â”‚â”‚
â”‚         â”‚  â”‚ Trip #1235 - On Trip    â”‚ â”‚  Offline: 12                      â”‚â”‚
â”‚ â–¡ Alertsâ”‚  â”‚ Trip #1236 - Waiting    â”‚ â”‚                                   â”‚â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Dispatcher Actions

```
Manual Dispatch Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Receive  â”‚â”€â”€â”€â–¶â”‚ View     â”‚â”€â”€â”€â–¶â”‚ Select   â”‚â”€â”€â”€â–¶â”‚ Confirm  â”‚
â”‚ Booking  â”‚    â”‚ Nearby   â”‚    â”‚ Driver   â”‚    â”‚ Dispatch â”‚
â”‚          â”‚    â”‚ Drivers  â”‚    â”‚          â”‚    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Emergency Response:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SOS      â”‚â”€â”€â”€â–¶â”‚ Alert    â”‚â”€â”€â”€â–¶â”‚ Contact  â”‚â”€â”€â”€â–¶â”‚ Log      â”‚
â”‚ Triggeredâ”‚    â”‚ Displayedâ”‚    â”‚ Parties  â”‚    â”‚ Incident â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Admin Panel Features

### Super Admin (Platform Owner)

| Module | Features |
|--------|----------|
| **Tenant Management** | Create/manage taxi companies, subscription plans |
| **Billing** | SaaS billing, invoices, payment tracking |
| **Platform Analytics** | Cross-tenant metrics, platform health |
| **Feature Flags** | Enable/disable features per tenant |
| **White-Label Config** | Manage branding templates |
| **Support Tickets** | Handle tenant support requests |
| **System Settings** | Global configurations, API keys |

### Tenant Admin (Taxi Company Owner)

| Module | Features |
|--------|----------|
| **Dashboard** | KPIs, revenue, active drivers, trip counts |
| **Driver Management** | Onboard, verify, suspend, incentive programs |
| **Vehicle Management** | Fleet registry, maintenance schedules |
| **Pricing Configuration** | Set base fares, surge rules, zone pricing |
| **Promotions** | Create promo codes, referral programs |
| **Reports** | Revenue, driver performance, customer analytics |
| **Zone Management** | Service areas, no-go zones, airport queues |
| **Settings** | Company profile, branding, notifications |
| **Payout Management** | Driver payouts, commission settings |
| **Customer Support** | View complaints, issue refunds |

### Admin Panel Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ADMIN PANEL LAYERS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    SUPER ADMIN LAYER                        â”‚â”‚
â”‚  â”‚  â€¢ Platform-wide settings    â€¢ Tenant provisioning          â”‚â”‚
â”‚  â”‚  â€¢ SaaS billing             â€¢ System monitoring             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    TENANT ADMIN LAYER                       â”‚â”‚
â”‚  â”‚  â€¢ Company settings         â€¢ Driver management             â”‚â”‚
â”‚  â”‚  â€¢ Pricing rules            â€¢ Fleet management              â”‚â”‚
â”‚  â”‚  â€¢ Reports & analytics      â€¢ Customer support              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  DISPATCHER/OPERATOR LAYER                  â”‚â”‚
â”‚  â”‚  â€¢ Live operations          â€¢ Trip management               â”‚â”‚
â”‚  â”‚  â€¢ Driver monitoring        â€¢ Customer support              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Technical Architecture

### Flutter Clean Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRESENTATION LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Widgets  â—„â”€â”€â”€â”€â”€â”€â–º  BLoC/Cubit  â—„â”€â”€â”€â”€â”€â”€â–º  States/Events   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      DOMAIN LAYER                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Entities    â”‚  â”‚  Use Cases    â”‚  â”‚ Repositories  â”‚        â”‚
â”‚  â”‚   (Models)    â”‚  â”‚  (Business    â”‚  â”‚  (Abstract)   â”‚        â”‚
â”‚  â”‚               â”‚  â”‚   Logic)      â”‚  â”‚               â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       DATA LAYER                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Repositories â”‚  â”‚ Data Sources  â”‚  â”‚    Models     â”‚        â”‚
â”‚  â”‚   (Impl)      â”‚  â”‚ (Remote/Local)â”‚  â”‚   (DTOs)      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   INFRASTRUCTURE LAYER                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Firebase â”‚  â”‚  HTTP    â”‚  â”‚  Socket  â”‚  â”‚  Local   â”‚         â”‚
â”‚  â”‚ Adapter  â”‚  â”‚  Client  â”‚  â”‚  Client  â”‚  â”‚  Storage â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Bloc State Management Pattern

```dart
// Event
abstract class TripEvent {}
class RequestTripEvent extends TripEvent {
  final Location pickup;
  final Location dropoff;
  final VehicleType vehicleType;
}

// State
abstract class TripState {}
class TripInitial extends TripState {}
class TripLoading extends TripState {}
class TripSearchingDriver extends TripState {}
class TripDriverMatched extends TripState {
  final Driver driver;
  final Duration eta;
}
class TripInProgress extends TripState {
  final Trip trip;
  final Location driverLocation;
}

// Bloc
class TripBloc extends Bloc<TripEvent, TripState> {
  final RequestTripUseCase requestTrip;
  final StreamTripUpdatesUseCase streamTripUpdates;

  TripBloc({required this.requestTrip, required this.streamTripUpdates})
    : super(TripInitial());
}
```

---

## 7. Real-Time GPS & Socket Architecture

### Location Update Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Driver    â”‚         â”‚   Server    â”‚         â”‚  Passenger  â”‚
â”‚    App      â”‚         â”‚  (Socket)   â”‚         â”‚    App      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚                       â”‚
       â”‚  Location Update      â”‚                       â”‚
       â”‚  (lat, lng, heading,  â”‚                       â”‚
       â”‚   speed, timestamp)   â”‚                       â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚   Broadcast to        â”‚
       â”‚                       â”‚   subscribed clients  â”‚
       â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚   Store in Redis      â”‚
       â”‚                       â”‚   (hot data)          â”‚
       â”‚                       â”‚                       â”‚
       â”‚                       â”‚   Batch to Firestore  â”‚
       â”‚                       â”‚   (every 30s)         â”‚
       â”‚                       â”‚                       â”‚
```

### Socket Events Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SOCKET EVENT CHANNELS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  DRIVER CHANNELS:                                                â”‚
â”‚  â”œâ”€â”€ driver:{driverId}:location      # Location updates         â”‚
â”‚  â”œâ”€â”€ driver:{driverId}:trip_request  # New trip requests        â”‚
â”‚  â”œâ”€â”€ driver:{driverId}:trip_update   # Trip status changes      â”‚
â”‚  â””â”€â”€ driver:{driverId}:messages      # Dispatcher messages      â”‚
â”‚                                                                  â”‚
â”‚  PASSENGER CHANNELS:                                             â”‚
â”‚  â”œâ”€â”€ passenger:{passengerId}:trip    # Trip updates             â”‚
â”‚  â”œâ”€â”€ passenger:{passengerId}:driver_location  # Driver GPS      â”‚
â”‚  â””â”€â”€ passenger:{passengerId}:messages # Driver messages         â”‚
â”‚                                                                  â”‚
â”‚  DISPATCHER CHANNELS:                                            â”‚
â”‚  â”œâ”€â”€ tenant:{tenantId}:all_drivers   # All driver locations     â”‚
â”‚  â”œâ”€â”€ tenant:{tenantId}:all_trips     # All active trips         â”‚
â”‚  â”œâ”€â”€ tenant:{tenantId}:alerts        # System alerts            â”‚
â”‚  â””â”€â”€ tenant:{tenantId}:sos           # Emergency alerts         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation Options

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 REAL-TIME IMPLEMENTATION OPTIONS                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  PHASE 1 - FIREBASE (Initial):                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Firestore Real-time Listeners                            â”‚   â”‚
â”‚  â”‚  â€¢ Cloud Functions for business logic                       â”‚   â”‚
â”‚  â”‚  â€¢ Firebase Cloud Messaging for push                        â”‚   â”‚
â”‚  â”‚  â€¢ GeoFirestore for location queries                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  PHASE 2 - HYBRID (Scale):                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Socket.IO / WebSocket server for real-time               â”‚   â”‚
â”‚  â”‚  â€¢ Redis Pub/Sub for message distribution                   â”‚   â”‚
â”‚  â”‚  â€¢ Firebase for auth + some data                            â”‚   â”‚
â”‚  â”‚  â€¢ Custom API for complex operations                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  PHASE 3 - CUSTOM (Full Control):                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Custom WebSocket server (Node.js/Go)                     â”‚   â”‚
â”‚  â”‚  â€¢ PostgreSQL + PostGIS for geospatial                      â”‚   â”‚
â”‚  â”‚  â€¢ Redis for caching + pub/sub                              â”‚   â”‚
â”‚  â”‚  â€¢ Kubernetes for scaling                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Location Data Model

```dart
class DriverLocation {
  final String driverId;
  final double latitude;
  final double longitude;
  final double heading;        // Direction in degrees
  final double speed;          // km/h
  final double accuracy;       // GPS accuracy in meters
  final DateTime timestamp;
  final String? currentTripId;
  final DriverStatus status;
  final GeoHash geoHash;       // For efficient geo queries
}
```

---

## 8. Trip Pricing Engine

### Pricing Model Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRICING ENGINE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    INPUT FACTORS                            â”‚â”‚
â”‚  â”‚  â€¢ Distance (km)           â€¢ Duration (min)                 â”‚â”‚
â”‚  â”‚  â€¢ Vehicle Type            â€¢ Time of Day                    â”‚â”‚
â”‚  â”‚  â€¢ Day of Week             â€¢ Current Demand                 â”‚â”‚
â”‚  â”‚  â€¢ Weather Conditions      â€¢ Special Events                 â”‚â”‚
â”‚  â”‚  â€¢ Zone (Airport, Downtown)â€¢ Toll Roads                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  PRICING FORMULA                            â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  Total = BaseFare                                           â”‚â”‚
â”‚  â”‚        + (Distance Ã— PerKmRate)                             â”‚â”‚
â”‚  â”‚        + (Duration Ã— PerMinRate)                            â”‚â”‚
â”‚  â”‚        + SurgePricing                                       â”‚â”‚
â”‚  â”‚        + Tolls                                              â”‚â”‚
â”‚  â”‚        + AirportFee                                         â”‚â”‚
â”‚  â”‚        - PromoDiscount                                      â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  Final = max(Total, MinimumFare)                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                   OUTPUT                                    â”‚â”‚
â”‚  â”‚  â€¢ Estimated Fare Range (min-max)                           â”‚â”‚
â”‚  â”‚  â€¢ Fare Breakdown                                           â”‚â”‚
â”‚  â”‚  â€¢ Surge Multiplier Applied                                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pricing Configuration (Tenant-Specific)

```dart
class PricingConfig {
  final String tenantId;
  final String vehicleTypeId;

  // Base pricing
  final double baseFare;
  final double minimumFare;
  final double perKmRate;
  final double perMinuteRate;
  final double bookingFee;

  // Surge pricing
  final bool surgeEnabled;
  final double maxSurgeMultiplier;
  final List<SurgeTier> surgeTiers;

  // Time-based pricing
  final Map<TimeSlot, double> timeMultipliers;

  // Zone-based pricing
  final List<ZonePricing> zonePricing;

  // Special fees
  final double airportPickupFee;
  final double airportDropoffFee;
  final double waitingChargePerMin;
  final double cancellationFee;
}

class SurgeTier {
  final double demandThreshold;  // e.g., 1.5 = 150% of normal demand
  final double multiplier;       // e.g., 1.5x pricing
}
```

### Surge Pricing Algorithm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SURGE PRICING CALCULATION                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Define Service Zone (GeoHash precision 6)                   â”‚
â”‚                                                                  â”‚
â”‚  2. Calculate Demand Score:                                      â”‚
â”‚     demand = active_ride_requests / time_window                  â”‚
â”‚                                                                  â”‚
â”‚  3. Calculate Supply Score:                                      â”‚
â”‚     supply = available_drivers_in_zone                           â”‚
â”‚                                                                  â”‚
â”‚  4. Calculate Demand/Supply Ratio:                               â”‚
â”‚     ratio = demand / supply                                      â”‚
â”‚                                                                  â”‚
â”‚  5. Apply Surge Tier:                                            â”‚
â”‚     if ratio > 3.0  â†’ 2.0x surge                                â”‚
â”‚     if ratio > 2.0  â†’ 1.5x surge                                â”‚
â”‚     if ratio > 1.5  â†’ 1.25x surge                               â”‚
â”‚     else            â†’ 1.0x (no surge)                           â”‚
â”‚                                                                  â”‚
â”‚  6. Cap at Maximum Surge (configured per tenant)                 â”‚
â”‚                                                                  â”‚
â”‚  7. Display Surge to User Before Confirmation                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Route Optimization

### Route Service Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ROUTE OPTIMIZATION SERVICE                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  ROUTING PROVIDERS                          â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚
â”‚  â”‚  â”‚  Google  â”‚  â”‚ Mapbox   â”‚  â”‚  HERE    â”‚  â”‚  OSRM    â”‚    â”‚â”‚
â”‚  â”‚  â”‚  Maps    â”‚  â”‚          â”‚  â”‚          â”‚  â”‚ (Self-   â”‚    â”‚â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚  hosted) â”‚    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                 ROUTE ABSTRACTION LAYER                     â”‚â”‚
â”‚  â”‚  â€¢ Provider failover                                        â”‚â”‚
â”‚  â”‚  â€¢ Response caching                                         â”‚â”‚
â”‚  â”‚  â€¢ Cost optimization (choose cheapest provider)             â”‚â”‚
â”‚  â”‚  â€¢ Rate limiting                                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    ROUTE FEATURES                           â”‚â”‚
â”‚  â”‚  â€¢ Fastest route calculation                                â”‚â”‚
â”‚  â”‚  â€¢ Alternative routes                                       â”‚â”‚
â”‚  â”‚  â€¢ Real-time traffic consideration                          â”‚â”‚
â”‚  â”‚  â€¢ ETA prediction                                           â”‚â”‚
â”‚  â”‚  â€¢ Turn-by-turn navigation                                  â”‚â”‚
â”‚  â”‚  â€¢ Route deviation detection                                â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Driver Matching Algorithm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DRIVER MATCHING ALGORITHM                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Step 1: Find Nearby Drivers                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  â€¢ Query drivers within radius (default: 5km)                    â”‚
â”‚  â€¢ Filter by: online status, vehicle type, capacity              â”‚
â”‚  â€¢ Use GeoHash for efficient spatial queries                     â”‚
â”‚                                                                  â”‚
â”‚  Step 2: Calculate Scores                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  For each driver:                                                â”‚
â”‚    score = w1 Ã— (1 / distance)           # Proximity             â”‚
â”‚          + w2 Ã— (1 / eta)                # Time to pickup        â”‚
â”‚          + w3 Ã— driver_rating            # Quality               â”‚
â”‚          + w4 Ã— acceptance_rate          # Reliability           â”‚
â”‚          - w5 Ã— time_since_last_trip     # Fairness             â”‚
â”‚                                                                  â”‚
â”‚  Step 3: Sort and Select                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚  â€¢ Sort drivers by score descending                              â”‚
â”‚  â€¢ Send request to top driver                                    â”‚
â”‚  â€¢ If declined/timeout â†’ next driver                             â”‚
â”‚  â€¢ Repeat up to MAX_ATTEMPTS                                     â”‚
â”‚                                                                  â”‚
â”‚  Step 4: Fallback                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚  â€¢ Expand search radius                                          â”‚
â”‚  â€¢ Notify dispatcher for manual assignment                       â”‚
â”‚  â€¢ Notify passenger of delay                                     â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ETA Prediction Model

```dart
class ETACalculator {
  // Calculate pickup ETA
  Duration calculatePickupETA({
    required Location driverLocation,
    required Location pickupLocation,
    required TrafficConditions traffic,
    required DateTime requestTime,
  }) {
    // Base ETA from routing API
    var baseEta = routingService.getETA(driverLocation, pickupLocation);

    // Apply historical accuracy factor
    var historicalFactor = getHistoricalAccuracyFactor(
      zone: pickupLocation.geoHash,
      dayOfWeek: requestTime.weekday,
      hourOfDay: requestTime.hour,
    );

    // Apply traffic factor
    var trafficFactor = traffic.congestionLevel; // 1.0 - 2.5

    return baseEta * historicalFactor * trafficFactor;
  }
}
```

---

## 10. Wallet System

### Wallet Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WALLET SYSTEM                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    WALLET TYPES                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚â”‚
â”‚  â”‚  â”‚  PASSENGER     â”‚  â”‚    DRIVER      â”‚                     â”‚â”‚
â”‚  â”‚  â”‚  WALLET        â”‚  â”‚    WALLET      â”‚                     â”‚â”‚
â”‚  â”‚  â”‚                â”‚  â”‚                â”‚                     â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Top-up       â”‚  â”‚ â€¢ Trip earningsâ”‚                     â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Pay for ridesâ”‚  â”‚ â€¢ Cash settle  â”‚                     â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Refunds      â”‚  â”‚ â€¢ Withdrawals  â”‚                     â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Promo creditsâ”‚  â”‚ â€¢ Incentives   â”‚                     â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                 TRANSACTION TYPES                           â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  CREDIT:                     DEBIT:                         â”‚â”‚
â”‚  â”‚  â€¢ Top-up (card/bank)        â€¢ Ride payment                 â”‚â”‚
â”‚  â”‚  â€¢ Refund                    â€¢ Withdrawal                   â”‚â”‚
â”‚  â”‚  â€¢ Promotional credit        â€¢ Commission deduction         â”‚â”‚
â”‚  â”‚  â€¢ Trip earning              â€¢ Penalty                      â”‚â”‚
â”‚  â”‚  â€¢ Incentive bonus           â€¢ Cash collection settle       â”‚â”‚
â”‚  â”‚  â€¢ Referral bonus                                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Wallet Transaction Flow

```
PASSENGER PAYMENT FLOW:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Trip    â”‚â”€â”€â”€â–¶â”‚ Calculateâ”‚â”€â”€â”€â–¶â”‚ Process  â”‚â”€â”€â”€â–¶â”‚ Update   â”‚
â”‚ Complete â”‚    â”‚  Fare    â”‚    â”‚ Payment  â”‚    â”‚ Wallets  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                 â–¼                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Wallet  â”‚      â”‚   Card   â”‚      â”‚   Cash   â”‚
              â”‚ Payment  â”‚      â”‚ Payment  â”‚      â”‚ (Driver  â”‚
              â”‚          â”‚      â”‚          â”‚      â”‚ collects)â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DRIVER EARNING FLOW:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Trip   â”‚â”€â”€â”€â–¶â”‚ Calculateâ”‚â”€â”€â”€â–¶â”‚  Deduct  â”‚â”€â”€â”€â–¶â”‚  Credit  â”‚
â”‚ Complete â”‚    â”‚ Earning  â”‚    â”‚Commissionâ”‚    â”‚  Driver  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚  Driver  â”‚
                                               â”‚  Wallet  â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Wallet Data Models

```dart
class Wallet {
  final String id;
  final String ownerId;
  final WalletType type; // PASSENGER, DRIVER, TENANT
  final double balance;
  final double pendingBalance; // Funds on hold
  final String currency;
  final bool isActive;
  final DateTime createdAt;
  final DateTime updatedAt;
}

class WalletTransaction {
  final String id;
  final String walletId;
  final TransactionType type;
  final double amount;
  final double balanceAfter;
  final String? referenceId; // Trip ID, Payout ID, etc.
  final String description;
  final TransactionStatus status;
  final Map<String, dynamic>? metadata;
  final DateTime createdAt;
}

enum TransactionType {
  topUp,
  ridePayment,
  tripEarning,
  commission,
  withdrawal,
  refund,
  promoCredit,
  incentiveBonus,
  cashSettlement,
  penalty,
}
```

### Payment Gateway Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PAYMENT GATEWAY ABSTRACTION                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              PaymentGatewayInterface                        â”‚â”‚
â”‚  â”‚  â€¢ createCustomer()                                         â”‚â”‚
â”‚  â”‚  â€¢ addPaymentMethod()                                       â”‚â”‚
â”‚  â”‚  â€¢ charge()                                                 â”‚â”‚
â”‚  â”‚  â€¢ refund()                                                 â”‚â”‚
â”‚  â”‚  â€¢ createPayout()                                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                                   â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â–¼                      â–¼                      â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Stripe  â”‚          â”‚ Razorpay â”‚          â”‚  PayPal  â”‚       â”‚
â”‚  â”‚ Adapter  â”‚          â”‚ Adapter  â”‚          â”‚ Adapter  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. Review & Rating Module

### Rating System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RATING SYSTEM                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              BIDIRECTIONAL RATINGS                          â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚    PASSENGER â†’ DRIVER          DRIVER â†’ PASSENGER           â”‚â”‚
â”‚  â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚â”‚
â”‚  â”‚    â€¢ Overall (1-5 stars)      â€¢ Overall (1-5 stars)         â”‚â”‚
â”‚  â”‚    â€¢ Professionalism          â€¢ Behavior                    â”‚â”‚
â”‚  â”‚    â€¢ Vehicle cleanliness      â€¢ Punctuality                 â”‚â”‚
â”‚  â”‚    â€¢ Navigation               â€¢ Pickup location accuracy    â”‚â”‚
â”‚  â”‚    â€¢ Safety                   â€¢ Communication               â”‚â”‚
â”‚  â”‚    â€¢ Written feedback         â€¢ Written feedback            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              RATING PROMPTS                                 â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  Low Rating Triggers:                                       â”‚â”‚
â”‚  â”‚  â€¢ â‰¤ 3 stars: Require feedback reason selection             â”‚â”‚
â”‚  â”‚  â€¢ â‰¤ 2 stars: Require written explanation                   â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  Feedback Options (Low Passengerâ†’Driver):                   â”‚â”‚
â”‚  â”‚  â–¡ Rude behavior        â–¡ Unsafe driving                    â”‚â”‚
â”‚  â”‚  â–¡ Dirty vehicle        â–¡ Wrong route taken                 â”‚â”‚
â”‚  â”‚  â–¡ Asked to cancel      â–¡ Overcharged                       â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  Feedback Options (Low Driverâ†’Passenger):                   â”‚â”‚
â”‚  â”‚  â–¡ Rude behavior        â–¡ Incorrect pickup                  â”‚â”‚
â”‚  â”‚  â–¡ Made me wait         â–¡ Inappropriate behavior            â”‚â”‚
â”‚  â”‚  â–¡ Tried to scam        â–¡ Damaged vehicle                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Rating Calculation

```dart
class RatingService {
  // Calculate weighted average rating
  double calculateAverageRating(String entityId, EntityType type) {
    final ratings = getRatings(entityId, type, limit: 500);

    if (ratings.isEmpty) return 5.0; // New users start at 5.0

    // Weight recent ratings more heavily
    double weightedSum = 0;
    double weightSum = 0;

    for (var i = 0; i < ratings.length; i++) {
      // More recent = higher weight
      double weight = 1.0 / (1 + (i * 0.01));
      weightedSum += ratings[i].score * weight;
      weightSum += weight;
    }

    return weightedSum / weightSum;
  }

  // Check if rating triggers alert
  bool shouldTriggerAlert(Rating rating) {
    return rating.score <= 2 ||
           rating.categories.contains(RatingCategory.safetyIssue);
  }
}
```

### Rating Data Models

```dart
class Rating {
  final String id;
  final String tripId;
  final String raterId;
  final String ratedId;
  final RaterType raterType; // PASSENGER, DRIVER
  final int score; // 1-5
  final List<RatingCategory>? categories;
  final String? comment;
  final bool isAnonymous;
  final DateTime createdAt;
}

class UserRatingSummary {
  final String userId;
  final double averageRating;
  final int totalRatings;
  final Map<int, int> ratingDistribution; // {5: 100, 4: 50, ...}
  final List<String> topCompliments;
  final DateTime lastUpdated;
}
```

---

## 12. Fleet Management

### Fleet Management Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   FLEET MANAGEMENT                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                 VEHICLE REGISTRY                            â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚â”‚
â”‚  â”‚  â”‚   Vehicle    â”‚  â”‚   Vehicle    â”‚  â”‚   Vehicle    â”‚       â”‚â”‚
â”‚  â”‚  â”‚   Details    â”‚  â”‚   Documents  â”‚  â”‚  Maintenance â”‚       â”‚â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚       â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Make/Model â”‚  â”‚ â€¢ Insurance  â”‚  â”‚ â€¢ Schedule   â”‚       â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Plate No.  â”‚  â”‚ â€¢ Permit     â”‚  â”‚ â€¢ History    â”‚       â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Color      â”‚  â”‚ â€¢ Inspection â”‚  â”‚ â€¢ Alerts     â”‚       â”‚â”‚
â”‚  â”‚  â”‚ â€¢ VIN        â”‚  â”‚ â€¢ Expiry     â”‚  â”‚ â€¢ Mileage    â”‚       â”‚â”‚
â”‚  â”‚  â”‚ â€¢ Capacity   â”‚  â”‚   Tracking   â”‚  â”‚              â”‚       â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚               VEHICLE TYPES CONFIGURATION                   â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚
â”‚  â”‚  â”‚Economy â”‚ â”‚Comfort â”‚ â”‚Premium â”‚ â”‚  SUV   â”‚ â”‚  Van   â”‚    â”‚â”‚
â”‚  â”‚  â”‚  ğŸš—   â”‚ â”‚  ğŸš™   â”‚ â”‚  ğŸš˜   â”‚ â”‚  ğŸš   â”‚ â”‚  ğŸšŒ   â”‚    â”‚â”‚
â”‚  â”‚  â”‚ 4 pax  â”‚ â”‚ 4 pax  â”‚ â”‚ 4 pax  â”‚ â”‚ 6 pax  â”‚ â”‚ 8 pax  â”‚    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              DRIVER-VEHICLE ASSIGNMENT                      â”‚â”‚
â”‚  â”‚                                                             â”‚â”‚
â”‚  â”‚  â€¢ Primary vehicle assignment                               â”‚â”‚
â”‚  â”‚  â€¢ Shared vehicle scheduling                                â”‚â”‚
â”‚  â”‚  â€¢ Shift management                                         â”‚â”‚
â”‚  â”‚  â€¢ Vehicle swap requests                                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Vehicle Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Register â”‚â”€â”€â”€â–¶â”‚ Document â”‚â”€â”€â”€â–¶â”‚ Approve  â”‚â”€â”€â”€â–¶â”‚  Active  â”‚
â”‚ Vehicle  â”‚    â”‚ Verify   â”‚    â”‚          â”‚    â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚                                 â”‚
                    â–¼                                 â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Under   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Scheduledâ”‚
              â”‚Maintenance                     â”‚Maintenance
              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Returned â”‚â”€â”€â”€â–¶â”‚ Retired  â”‚
              â”‚to Active â”‚    â”‚          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Fleet Data Models

```dart
class Vehicle {
  final String id;
  final String tenantId;
  final String? assignedDriverId;

  // Vehicle details
  final String make;
  final String model;
  final int year;
  final String color;
  final String plateNumber;
  final String vin;
  final VehicleType type;
  final int passengerCapacity;
  final List<VehicleFeature> features; // AC, WiFi, etc.

  // Status
  final VehicleStatus status;
  final int currentMileage;
  final DateTime lastInspectionDate;
  final DateTime nextMaintenanceDate;

  // Documents
  final List<VehicleDocument> documents;

  final DateTime createdAt;
  final DateTime updatedAt;
}

class VehicleDocument {
  final String id;
  final String vehicleId;
  final DocumentType type; // INSURANCE, PERMIT, INSPECTION
  final String documentUrl;
  final DateTime issueDate;
  final DateTime expiryDate;
  final DocumentStatus status;
}

class MaintenanceRecord {
  final String id;
  final String vehicleId;
  final MaintenanceType type;
  final String description;
  final int mileageAtService;
  final double cost;
  final String? serviceProvider;
  final DateTime serviceDate;
  final DateTime? nextServiceDate;
}
```

---

## 13. Database Schema

### Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE SCHEMA                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  TENANTS                    USERS                      VEHICLES             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚  â€¢ id (PK)                  â€¢ id (PK)                  â€¢ id (PK)            â”‚
â”‚  â€¢ name                     â€¢ tenant_id (FK)           â€¢ tenant_id (FK)     â”‚
â”‚  â€¢ subdomain                â€¢ type (passenger/driver)  â€¢ driver_id (FK)     â”‚
â”‚  â€¢ config (JSON)            â€¢ phone                    â€¢ type               â”‚
â”‚  â€¢ subscription_plan        â€¢ email                    â€¢ plate_number       â”‚
â”‚  â€¢ status                   â€¢ full_name                â€¢ make/model         â”‚
â”‚  â€¢ created_at               â€¢ avatar_url               â€¢ status             â”‚
â”‚       â”‚                     â€¢ status                        â”‚               â”‚
â”‚       â”‚                     â€¢ created_at                    â”‚               â”‚
â”‚       â”‚                          â”‚                          â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚  DRIVER_PROFILES            TRIPS                      WALLET               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€                      â”€â”€â”€â”€â”€â”€               â”‚
â”‚  â€¢ id (PK)                  â€¢ id (PK)                  â€¢ id (PK)            â”‚
â”‚  â€¢ user_id (FK)             â€¢ tenant_id (FK)           â€¢ owner_id (FK)      â”‚
â”‚  â€¢ vehicle_id (FK)          â€¢ passenger_id (FK)        â€¢ type               â”‚
â”‚  â€¢ license_number           â€¢ driver_id (FK)           â€¢ balance            â”‚
â”‚  â€¢ average_rating           â€¢ vehicle_id (FK)          â€¢ currency           â”‚
â”‚  â€¢ total_trips              â€¢ status                   â€¢ status             â”‚
â”‚  â€¢ is_verified              â€¢ pickup_location               â”‚               â”‚
â”‚  â€¢ documents (JSON)         â€¢ dropoff_location               â”‚               â”‚
â”‚       â”‚                     â€¢ fare_amount                    â”‚               â”‚
â”‚       â”‚                     â€¢ payment_method                 â”‚               â”‚
â”‚       â”‚                     â€¢ created_at                     â”‚               â”‚
â”‚       â”‚                          â”‚                           â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                  â”‚                                          â”‚
â”‚                                  â–¼                                          â”‚
â”‚  RATINGS                   TRANSACTIONS               PROMO_CODES           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
â”‚  â€¢ id (PK)                 â€¢ id (PK)                  â€¢ id (PK)             â”‚
â”‚  â€¢ trip_id (FK)            â€¢ wallet_id (FK)           â€¢ tenant_id (FK)      â”‚
â”‚  â€¢ rater_id (FK)           â€¢ type                     â€¢ code                â”‚
â”‚  â€¢ rated_id (FK)           â€¢ amount                   â€¢ discount_type       â”‚
â”‚  â€¢ score                   â€¢ reference_id             â€¢ discount_value      â”‚
â”‚  â€¢ comment                 â€¢ status                   â€¢ max_uses            â”‚
â”‚  â€¢ categories              â€¢ created_at               â€¢ valid_until         â”‚
â”‚                                                                             â”‚
â”‚  PRICING_CONFIGS           LOCATIONS (Real-time)      NOTIFICATIONS         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”‚
â”‚  â€¢ id (PK)                 â€¢ driver_id (PK)           â€¢ id (PK)             â”‚
â”‚  â€¢ tenant_id (FK)          â€¢ latitude                 â€¢ user_id (FK)        â”‚
â”‚  â€¢ vehicle_type            â€¢ longitude                â€¢ type                â”‚
â”‚  â€¢ base_fare               â€¢ heading                  â€¢ title               â”‚
â”‚  â€¢ per_km_rate             â€¢ speed                    â€¢ body                â”‚
â”‚  â€¢ per_min_rate            â€¢ geo_hash                 â€¢ data (JSON)         â”‚
â”‚  â€¢ surge_config            â€¢ updated_at               â€¢ is_read             â”‚
â”‚                                                       â€¢ created_at          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Firestore Collection Structure

```
firestore/
â”œâ”€â”€ tenants/
â”‚   â””â”€â”€ {tenantId}/
â”‚       â”œâ”€â”€ config                    # Tenant configuration
â”‚       â”œâ”€â”€ pricing_configs/          # Pricing rules
â”‚       â”œâ”€â”€ promo_codes/              # Promotional codes
â”‚       â”œâ”€â”€ zones/                    # Service zones
â”‚       â””â”€â”€ settings                  # General settings
â”‚
â”œâ”€â”€ users/
â”‚   â””â”€â”€ {userId}/
â”‚       â”œâ”€â”€ profile                   # User profile data
â”‚       â”œâ”€â”€ saved_locations/          # Favorite places
â”‚       â”œâ”€â”€ payment_methods/          # Saved cards
â”‚       â””â”€â”€ notifications/            # User notifications
â”‚
â”œâ”€â”€ drivers/
â”‚   â””â”€â”€ {driverId}/
â”‚       â”œâ”€â”€ profile                   # Driver profile
â”‚       â”œâ”€â”€ documents/                # License, insurance
â”‚       â”œâ”€â”€ earnings/                 # Daily earnings
â”‚       â””â”€â”€ incentives/               # Active bonuses
â”‚
â”œâ”€â”€ vehicles/
â”‚   â””â”€â”€ {vehicleId}/
â”‚       â”œâ”€â”€ details                   # Vehicle info
â”‚       â”œâ”€â”€ documents/                # Vehicle documents
â”‚       â””â”€â”€ maintenance/              # Service records
â”‚
â”œâ”€â”€ trips/
â”‚   â””â”€â”€ {tripId}/
â”‚       â”œâ”€â”€ details                   # Trip data
â”‚       â”œâ”€â”€ route                     # Route polyline
â”‚       â”œâ”€â”€ timeline/                 # Status changes
â”‚       â””â”€â”€ ratings/                  # Trip ratings
â”‚
â”œâ”€â”€ wallets/
â”‚   â””â”€â”€ {walletId}/
â”‚       â”œâ”€â”€ balance                   # Current balance
â”‚       â””â”€â”€ transactions/             # Transaction history
â”‚
â”œâ”€â”€ locations/                        # Real-time (use Redis in scale)
â”‚   â””â”€â”€ {tenantId}/
â”‚       â””â”€â”€ drivers/
â”‚           â””â”€â”€ {driverId}            # Current location
â”‚
â””â”€â”€ analytics/
    â””â”€â”€ {tenantId}/
        â”œâ”€â”€ daily/                    # Daily aggregates
        â”œâ”€â”€ weekly/                   # Weekly aggregates
        â””â”€â”€ monthly/                  # Monthly aggregates
```

### Indexes for Performance

```javascript
// Firestore Composite Indexes

// Find available drivers near location
// Collection: locations/{tenantId}/drivers
// Fields: status ASC, geoHash ASC

// Find user's recent trips
// Collection: trips
// Fields: passengerId ASC, createdAt DESC

// Find driver's trips by date
// Collection: trips
// Fields: driverId ASC, createdAt DESC

// Find pending trips for tenant
// Collection: trips
// Fields: tenantId ASC, status ASC, createdAt ASC

// Find active promo codes
// Collection: tenants/{tenantId}/promo_codes
// Fields: isActive ASC, validUntil ASC
```

---

## 14. API Design

### RESTful API Endpoints

```yaml
# Authentication
POST   /api/v1/auth/register              # Register new user
POST   /api/v1/auth/login                 # Login with credentials
POST   /api/v1/auth/verify-otp            # Verify OTP
POST   /api/v1/auth/refresh-token         # Refresh access token
POST   /api/v1/auth/logout                # Logout user
POST   /api/v1/auth/forgot-password       # Request password reset

# User Profile
GET    /api/v1/users/me                   # Get current user
PATCH  /api/v1/users/me                   # Update profile
POST   /api/v1/users/me/avatar            # Upload avatar
GET    /api/v1/users/me/notifications     # Get notifications
DELETE /api/v1/users/{id}                 # Delete account

# Passenger Endpoints
GET    /api/v1/passenger/saved-locations  # Get saved places
POST   /api/v1/passenger/saved-locations  # Add saved place
GET    /api/v1/passenger/trips            # Get trip history
GET    /api/v1/passenger/trips/{id}       # Get trip details

# Trip Booking
POST   /api/v1/trips/estimate             # Get fare estimate
POST   /api/v1/trips                      # Create trip request
GET    /api/v1/trips/{id}                 # Get trip details
PATCH  /api/v1/trips/{id}/cancel          # Cancel trip
POST   /api/v1/trips/{id}/rate            # Rate trip

# Driver Endpoints
GET    /api/v1/driver/profile             # Get driver profile
PATCH  /api/v1/driver/status              # Update online status
GET    /api/v1/driver/trips               # Get trip history
GET    /api/v1/driver/earnings            # Get earnings summary
POST   /api/v1/driver/trips/{id}/accept   # Accept trip
POST   /api/v1/driver/trips/{id}/decline  # Decline trip
POST   /api/v1/driver/trips/{id}/arrive   # Arrive at pickup
POST   /api/v1/driver/trips/{id}/start    # Start trip
POST   /api/v1/driver/trips/{id}/complete # Complete trip
POST   /api/v1/driver/documents           # Upload documents

# Wallet
GET    /api/v1/wallet                     # Get wallet balance
GET    /api/v1/wallet/transactions        # Get transactions
POST   /api/v1/wallet/topup               # Top up wallet
POST   /api/v1/wallet/withdraw            # Request withdrawal

# Payments
GET    /api/v1/payments/methods           # Get payment methods
POST   /api/v1/payments/methods           # Add payment method
DELETE /api/v1/payments/methods/{id}      # Remove payment method

# Admin Endpoints
GET    /api/v1/admin/dashboard            # Dashboard stats
GET    /api/v1/admin/drivers              # List drivers
PATCH  /api/v1/admin/drivers/{id}/status  # Update driver status
GET    /api/v1/admin/trips                # List all trips
GET    /api/v1/admin/reports/revenue      # Revenue reports

# Tenant Management (Super Admin)
GET    /api/v1/tenants                    # List tenants
POST   /api/v1/tenants                    # Create tenant
GET    /api/v1/tenants/{id}               # Get tenant
PATCH  /api/v1/tenants/{id}               # Update tenant
GET    /api/v1/tenants/{id}/billing       # Billing info
```

### WebSocket Events

```yaml
# Client â†’ Server
location:update           # Driver sends location
trip:request              # Passenger requests trip
trip:cancel               # Cancel trip
trip:driver:accept        # Driver accepts
trip:driver:arrive        # Driver arrived
trip:driver:start         # Trip started
trip:driver:complete      # Trip completed
driver:status             # Online/offline toggle
chat:message              # Send chat message

# Server â†’ Client
trip:driver_matched       # Driver assigned
trip:driver_location      # Real-time driver location
trip:status_update        # Trip status changed
trip:request              # New trip request (to driver)
driver:trip_canceled      # Trip was canceled
notification:push         # Push notification
chat:received             # Received message
```

### API Response Format

```json
// Success Response
{
  "success": true,
  "data": {
    // Response payload
  },
  "meta": {
    "timestamp": "2024-01-15T10:30:00Z",
    "requestId": "req_abc123"
  }
}

// Error Response
{
  "success": false,
  "error": {
    "code": "TRIP_NOT_FOUND",
    "message": "The requested trip does not exist",
    "details": {}
  },
  "meta": {
    "timestamp": "2024-01-15T10:30:00Z",
    "requestId": "req_abc123"
  }
}

// Paginated Response
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 156,
    "hasMore": true
  }
}
```

---

## 15. Microservice Architecture

### Service Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MICROSERVICES ARCHITECTURE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         API GATEWAY                                   â”‚  â”‚
â”‚   â”‚   â€¢ Authentication    â€¢ Rate Limiting    â€¢ Request Routing           â”‚  â”‚
â”‚   â”‚   â€¢ Tenant Resolution â€¢ Load Balancing   â€¢ API Versioning            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                               â–¼                                       â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚   â”‚  â”‚  Auth   â”‚ â”‚  User   â”‚ â”‚  Trip   â”‚ â”‚ Driver  â”‚ â”‚Location â”‚        â”‚  â”‚
â”‚   â”‚  â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚        â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚   â”‚  â”‚ Pricing â”‚ â”‚ Payment â”‚ â”‚ Wallet  â”‚ â”‚ Rating  â”‚ â”‚ Notify  â”‚        â”‚  â”‚
â”‚   â”‚  â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚        â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚   â”‚  â”‚ Fleet   â”‚ â”‚Analyticsâ”‚ â”‚ Tenant  â”‚ â”‚  SaaS   â”‚ â”‚  Promo  â”‚        â”‚  â”‚
â”‚   â”‚  â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Service â”‚ â”‚ Billing â”‚ â”‚ Service â”‚        â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    MESSAGE BROKER (Redis/RabbitMQ)                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                   â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         DATA LAYER                                    â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚   â”‚   â”‚ Firestoreâ”‚  â”‚  Redis   â”‚  â”‚PostgreSQLâ”‚  â”‚  S3/GCS  â”‚             â”‚  â”‚
â”‚   â”‚   â”‚ (NoSQL)  â”‚  â”‚ (Cache)  â”‚  â”‚ (Future) â”‚  â”‚ (Files)  â”‚             â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Service Responsibilities

| Service | Responsibilities |
|---------|-----------------|
| **Auth Service** | User registration, login, OTP, JWT tokens, sessions |
| **User Service** | Profile management, preferences, saved locations |
| **Trip Service** | Booking, trip lifecycle, matching, status management |
| **Driver Service** | Driver onboarding, documents, status, availability |
| **Location Service** | Real-time GPS, geofencing, proximity queries |
| **Pricing Service** | Fare calculation, surge pricing, estimates |
| **Payment Service** | Payment processing, gateway integration |
| **Wallet Service** | Balance management, transactions, payouts |
| **Rating Service** | Reviews, ratings, feedback management |
| **Notify Service** | Push notifications, SMS, email |
| **Fleet Service** | Vehicle management, maintenance, assignments |
| **Analytics Service** | Metrics, reports, dashboards |
| **Tenant Service** | Multi-tenancy, configuration, branding |
| **SaaS Billing** | Subscription management, invoicing |
| **Promo Service** | Coupons, referrals, campaigns |

### Event-Driven Communication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EVENT FLOW EXAMPLES                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  TRIP BOOKING EVENT FLOW:                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚                                                                  â”‚
â”‚  [Passenger App]                                                 â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼ POST /trips                                              â”‚
â”‚  [Trip Service]                                                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”œâ”€â”€â–¶ Publish: trip.requested                              â”‚
â”‚       â”‚         â”‚                                                â”‚
â”‚       â”‚         â”œâ”€â”€â–¶ [Pricing Service] Calculate fare           â”‚
â”‚       â”‚         â”œâ”€â”€â–¶ [Location Service] Find nearby drivers     â”‚
â”‚       â”‚         â””â”€â”€â–¶ [Analytics Service] Log request            â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼ Driver matched                                           â”‚
â”‚  [Trip Service]                                                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”œâ”€â”€â–¶ Publish: trip.driver_assigned                        â”‚
â”‚       â”‚         â”‚                                                â”‚
â”‚       â”‚         â”œâ”€â”€â–¶ [Notify Service] Notify passenger          â”‚
â”‚       â”‚         â”œâ”€â”€â–¶ [Notify Service] Notify driver             â”‚
â”‚       â”‚         â””â”€â”€â–¶ [Driver Service] Update status             â”‚
â”‚                                                                  â”‚
â”‚  TRIP COMPLETE EVENT FLOW:                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚                                                                  â”‚
â”‚  [Driver App]                                                    â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼ POST /trips/{id}/complete                                â”‚
â”‚  [Trip Service]                                                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”œâ”€â”€â–¶ Publish: trip.completed                              â”‚
â”‚       â”‚         â”‚                                                â”‚
â”‚       â”‚         â”œâ”€â”€â–¶ [Payment Service] Process payment          â”‚
â”‚       â”‚         â”œâ”€â”€â–¶ [Wallet Service] Credit driver             â”‚
â”‚       â”‚         â”œâ”€â”€â–¶ [Rating Service] Request ratings           â”‚
â”‚       â”‚         â”œâ”€â”€â–¶ [Analytics Service] Update metrics         â”‚
â”‚       â”‚         â””â”€â”€â–¶ [SaaS Billing] Record for billing          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 16. SaaS Pricing Model

### Subscription Tiers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SAAS PRICING TIERS                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚    STARTER      â”‚  â”‚   GROWTH        â”‚  â”‚   ENTERPRISE    â”‚              â”‚
â”‚  â”‚   $299/month    â”‚  â”‚   $799/month    â”‚  â”‚   Custom        â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚ â€¢ Up to 50      â”‚  â”‚ â€¢ Up to 200     â”‚  â”‚ â€¢ Unlimited     â”‚              â”‚
â”‚  â”‚   drivers       â”‚  â”‚   drivers       â”‚  â”‚   drivers       â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚ â€¢ 2,000 trips   â”‚  â”‚ â€¢ 10,000 trips  â”‚  â”‚ â€¢ Unlimited     â”‚              â”‚
â”‚  â”‚   per month     â”‚  â”‚   per month     â”‚  â”‚   trips         â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚ â€¢ Basic         â”‚  â”‚ â€¢ Advanced      â”‚  â”‚ â€¢ Full          â”‚              â”‚
â”‚  â”‚   analytics     â”‚  â”‚   analytics     â”‚  â”‚   analytics     â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚ â€¢ Email support â”‚  â”‚ â€¢ Priority      â”‚  â”‚ â€¢ Dedicated     â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚   support       â”‚  â”‚   support       â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚ â€¢ Standard      â”‚  â”‚ â€¢ Custom        â”‚  â”‚ â€¢ White-label   â”‚              â”‚
â”‚  â”‚   branding      â”‚  â”‚   branding      â”‚  â”‚   apps          â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚ â€¢ API access    â”‚  â”‚ â€¢ Full API      â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚ â€¢ Dispatcher    â”‚  â”‚ â€¢ Dedicated     â”‚              â”‚
â”‚  â”‚                 â”‚  â”‚   dashboard     â”‚  â”‚   infrastructureâ”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                          PER-RIDE PRICING                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Base subscription + per-completed-ride fee:                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  Tier          Base Fee    Per Ride    Included Rides   Overage     â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚  Starter       $199/mo     $0.15       1,000            $0.20       â”‚   â”‚
â”‚  â”‚  Growth        $499/mo     $0.10       5,000            $0.12       â”‚   â”‚
â”‚  â”‚  Enterprise    Custom      $0.05       Unlimited        N/A         â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚  OR Revenue Share Model:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Platform takes 2-5% of each completed trip fare                   â”‚   â”‚
â”‚  â”‚  â€¢ Lower percentage for higher volume                                â”‚   â”‚
â”‚  â”‚  â€¢ Minimum monthly commitment applies                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Billing Implementation

```dart
class SaaSBillingService {
  // Calculate monthly bill for tenant
  Future<Invoice> calculateMonthlyBill(String tenantId, DateTime month) async {
    final tenant = await getTenant(tenantId);
    final subscription = tenant.subscription;

    // Get completed trips for the month
    final trips = await getCompletedTrips(tenantId, month);
    final tripCount = trips.length;

    double totalAmount = subscription.basePrice;

    // Calculate overage if applicable
    if (tripCount > subscription.includedTrips) {
      final overageTrips = tripCount - subscription.includedTrips;
      totalAmount += overageTrips * subscription.overageRate;
    }

    // Add per-ride fees
    totalAmount += tripCount * subscription.perRideRate;

    // Add any add-ons
    for (final addon in subscription.addons) {
      totalAmount += addon.price;
    }

    return Invoice(
      tenantId: tenantId,
      period: month,
      baseAmount: subscription.basePrice,
      tripCount: tripCount,
      perRideCharges: tripCount * subscription.perRideRate,
      overageCharges: calculateOverage(tripCount, subscription),
      addonCharges: calculateAddons(subscription.addons),
      totalAmount: totalAmount,
    );
  }
}
```

---

## 17. Flutter Clean Architecture

### Project Structure

```
lib/
â”œâ”€â”€ main.dart
â”œâ”€â”€ app.dart
â”œâ”€â”€ injection_container.dart          # Dependency injection
â”‚
â”œâ”€â”€ core/                             # Shared core functionality
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”œâ”€â”€ api_constants.dart
â”‚   â”‚   â”œâ”€â”€ app_constants.dart
â”‚   â”‚   â””â”€â”€ storage_keys.dart
â”‚   â”œâ”€â”€ error/
â”‚   â”‚   â”œâ”€â”€ exceptions.dart
â”‚   â”‚   â””â”€â”€ failures.dart
â”‚   â”œâ”€â”€ network/
â”‚   â”‚   â”œâ”€â”€ network_info.dart
â”‚   â”‚   â””â”€â”€ api_client.dart
â”‚   â”œâ”€â”€ usecases/
â”‚   â”‚   â””â”€â”€ usecase.dart             # Base use case interface
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ validators.dart
â”‚   â”‚   â”œâ”€â”€ formatters.dart
â”‚   â”‚   â””â”€â”€ helpers.dart
â”‚   â””â”€â”€ widgets/                     # Shared widgets
â”‚       â”œâ”€â”€ buttons/
â”‚       â”œâ”€â”€ inputs/
â”‚       â”œâ”€â”€ dialogs/
â”‚       â””â”€â”€ loading/
â”‚
â”œâ”€â”€ config/                          # App configuration
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ app_router.dart
â”‚   â”œâ”€â”€ themes/
â”‚   â”‚   â”œâ”€â”€ app_theme.dart
â”‚   â”‚   â”œâ”€â”€ colors.dart
â”‚   â”‚   â””â”€â”€ text_styles.dart
â”‚   â””â”€â”€ env/
â”‚       â””â”€â”€ environment.dart
â”‚
â””â”€â”€ features/                        # Feature modules
    â”‚
    â”œâ”€â”€ auth/                        # Authentication feature
    â”‚   â”œâ”€â”€ data/
    â”‚   â”‚   â”œâ”€â”€ datasources/
    â”‚   â”‚   â”‚   â”œâ”€â”€ auth_remote_datasource.dart
    â”‚   â”‚   â”‚   â””â”€â”€ auth_local_datasource.dart
    â”‚   â”‚   â”œâ”€â”€ models/
    â”‚   â”‚   â”‚   â”œâ”€â”€ user_model.dart
    â”‚   â”‚   â”‚   â””â”€â”€ auth_response_model.dart
    â”‚   â”‚   â””â”€â”€ repositories/
    â”‚   â”‚       â””â”€â”€ auth_repository_impl.dart
    â”‚   â”œâ”€â”€ domain/
    â”‚   â”‚   â”œâ”€â”€ entities/
    â”‚   â”‚   â”‚   â””â”€â”€ user.dart
    â”‚   â”‚   â”œâ”€â”€ repositories/
    â”‚   â”‚   â”‚   â””â”€â”€ auth_repository.dart
    â”‚   â”‚   â””â”€â”€ usecases/
    â”‚   â”‚       â”œâ”€â”€ login.dart
    â”‚   â”‚       â”œâ”€â”€ register.dart
    â”‚   â”‚       â”œâ”€â”€ verify_otp.dart
    â”‚   â”‚       â””â”€â”€ logout.dart
    â”‚   â””â”€â”€ presentation/
    â”‚       â”œâ”€â”€ bloc/
    â”‚       â”‚   â”œâ”€â”€ auth_bloc.dart
    â”‚       â”‚   â”œâ”€â”€ auth_event.dart
    â”‚       â”‚   â””â”€â”€ auth_state.dart
    â”‚       â”œâ”€â”€ pages/
    â”‚       â”‚   â”œâ”€â”€ login_page.dart
    â”‚       â”‚   â”œâ”€â”€ register_page.dart
    â”‚       â”‚   â””â”€â”€ otp_page.dart
    â”‚       â””â”€â”€ widgets/
    â”‚           â”œâ”€â”€ login_form.dart
    â”‚           â””â”€â”€ otp_input.dart
    â”‚
    â”œâ”€â”€ booking/                     # Trip booking feature
    â”‚   â”œâ”€â”€ data/
    â”‚   â”‚   â”œâ”€â”€ datasources/
    â”‚   â”‚   â”œâ”€â”€ models/
    â”‚   â”‚   â””â”€â”€ repositories/
    â”‚   â”œâ”€â”€ domain/
    â”‚   â”‚   â”œâ”€â”€ entities/
    â”‚   â”‚   â”‚   â”œâ”€â”€ trip.dart
    â”‚   â”‚   â”‚   â”œâ”€â”€ location.dart
    â”‚   â”‚   â”‚   â””â”€â”€ fare_estimate.dart
    â”‚   â”‚   â”œâ”€â”€ repositories/
    â”‚   â”‚   â””â”€â”€ usecases/
    â”‚   â”‚       â”œâ”€â”€ request_trip.dart
    â”‚   â”‚       â”œâ”€â”€ cancel_trip.dart
    â”‚   â”‚       â”œâ”€â”€ get_fare_estimate.dart
    â”‚   â”‚       â””â”€â”€ stream_trip_updates.dart
    â”‚   â””â”€â”€ presentation/
    â”‚       â”œâ”€â”€ bloc/
    â”‚       â”œâ”€â”€ pages/
    â”‚       â””â”€â”€ widgets/
    â”‚
    â”œâ”€â”€ tracking/                    # Real-time tracking feature
    â”‚   â”œâ”€â”€ data/
    â”‚   â”œâ”€â”€ domain/
    â”‚   â””â”€â”€ presentation/
    â”‚
    â”œâ”€â”€ wallet/                      # Wallet feature
    â”‚   â”œâ”€â”€ data/
    â”‚   â”œâ”€â”€ domain/
    â”‚   â””â”€â”€ presentation/
    â”‚
    â”œâ”€â”€ driver/                      # Driver-specific features
    â”‚   â”œâ”€â”€ data/
    â”‚   â”œâ”€â”€ domain/
    â”‚   â””â”€â”€ presentation/
    â”‚
    â”œâ”€â”€ ratings/                     # Rating feature
    â”‚   â”œâ”€â”€ data/
    â”‚   â”œâ”€â”€ domain/
    â”‚   â””â”€â”€ presentation/
    â”‚
    â”œâ”€â”€ profile/                     # User profile feature
    â”‚   â”œâ”€â”€ data/
    â”‚   â”œâ”€â”€ domain/
    â”‚   â””â”€â”€ presentation/
    â”‚
    â””â”€â”€ history/                     # Trip history feature
        â”œâ”€â”€ data/
        â”œâ”€â”€ domain/
        â””â”€â”€ presentation/
```

### Core Abstractions

```dart
// lib/core/usecases/usecase.dart
abstract class UseCase<Type, Params> {
  Future<Either<Failure, Type>> call(Params params);
}

abstract class StreamUseCase<Type, Params> {
  Stream<Either<Failure, Type>> call(Params params);
}

class NoParams extends Equatable {
  @override
  List<Object?> get props => [];
}

// lib/core/error/failures.dart
abstract class Failure extends Equatable {
  final String message;
  const Failure(this.message);

  @override
  List<Object?> get props => [message];
}

class ServerFailure extends Failure {
  const ServerFailure(super.message);
}

class NetworkFailure extends Failure {
  const NetworkFailure(super.message);
}

class CacheFailure extends Failure {
  const CacheFailure(super.message);
}

class AuthFailure extends Failure {
  const AuthFailure(super.message);
}
```

### Bloc Pattern Implementation

```dart
// lib/features/booking/presentation/bloc/trip_bloc.dart

// Events
abstract class TripEvent extends Equatable {
  @override
  List<Object?> get props => [];
}

class RequestTripEvent extends TripEvent {
  final Location pickup;
  final Location dropoff;
  final String vehicleTypeId;
  final String? promoCode;

  RequestTripEvent({
    required this.pickup,
    required this.dropoff,
    required this.vehicleTypeId,
    this.promoCode,
  });

  @override
  List<Object?> get props => [pickup, dropoff, vehicleTypeId, promoCode];
}

class CancelTripEvent extends TripEvent {
  final String tripId;
  final String reason;

  CancelTripEvent({required this.tripId, required this.reason});
}

class SubscribeToTripUpdatesEvent extends TripEvent {
  final String tripId;

  SubscribeToTripUpdatesEvent({required this.tripId});
}

// States
abstract class TripState extends Equatable {
  @override
  List<Object?> get props => [];
}

class TripInitial extends TripState {}

class TripLoading extends TripState {}

class TripSearchingDriver extends TripState {
  final String tripId;
  final Duration? estimatedWait;

  TripSearchingDriver({required this.tripId, this.estimatedWait});
}

class TripDriverMatched extends TripState {
  final Trip trip;
  final Driver driver;
  final Vehicle vehicle;
  final Duration eta;

  TripDriverMatched({
    required this.trip,
    required this.driver,
    required this.vehicle,
    required this.eta,
  });
}

class TripInProgress extends TripState {
  final Trip trip;
  final Location driverLocation;
  final List<LatLng> routePolyline;
  final Duration eta;

  TripInProgress({
    required this.trip,
    required this.driverLocation,
    required this.routePolyline,
    required this.eta,
  });
}

class TripCompleted extends TripState {
  final Trip trip;
  final FareBreakdown fareBreakdown;

  TripCompleted({required this.trip, required this.fareBreakdown});
}

class TripCancelled extends TripState {
  final String tripId;
  final String reason;

  TripCancelled({required this.tripId, required this.reason});
}

class TripError extends TripState {
  final String message;

  TripError({required this.message});
}

// Bloc
class TripBloc extends Bloc<TripEvent, TripState> {
  final RequestTripUseCase requestTrip;
  final CancelTripUseCase cancelTrip;
  final StreamTripUpdatesUseCase streamTripUpdates;

  StreamSubscription<Either<Failure, Trip>>? _tripSubscription;

  TripBloc({
    required this.requestTrip,
    required this.cancelTrip,
    required this.streamTripUpdates,
  }) : super(TripInitial()) {
    on<RequestTripEvent>(_onRequestTrip);
    on<CancelTripEvent>(_onCancelTrip);
    on<SubscribeToTripUpdatesEvent>(_onSubscribeToUpdates);
    on<_TripUpdatedEvent>(_onTripUpdated);
  }

  Future<void> _onRequestTrip(
    RequestTripEvent event,
    Emitter<TripState> emit,
  ) async {
    emit(TripLoading());

    final result = await requestTrip(RequestTripParams(
      pickup: event.pickup,
      dropoff: event.dropoff,
      vehicleTypeId: event.vehicleTypeId,
      promoCode: event.promoCode,
    ));

    result.fold(
      (failure) => emit(TripError(message: failure.message)),
      (trip) {
        emit(TripSearchingDriver(tripId: trip.id));
        add(SubscribeToTripUpdatesEvent(tripId: trip.id));
      },
    );
  }

  Future<void> _onSubscribeToUpdates(
    SubscribeToTripUpdatesEvent event,
    Emitter<TripState> emit,
  ) async {
    await _tripSubscription?.cancel();

    _tripSubscription = streamTripUpdates(
      StreamTripParams(tripId: event.tripId),
    ).listen((result) {
      result.fold(
        (failure) => add(_TripErrorEvent(failure.message)),
        (trip) => add(_TripUpdatedEvent(trip)),
      );
    });
  }

  @override
  Future<void> close() {
    _tripSubscription?.cancel();
    return super.close();
  }
}
```

---

## 18. Backend Abstraction Layer

### Repository Pattern for Backend Flexibility

```dart
// lib/core/data/datasource_interface.dart

/// Abstract interface for all remote data sources
/// Implementations can be Firebase, REST API, GraphQL, etc.
abstract class RemoteDataSource {
  Future<void> initialize();
  Future<void> dispose();
}

/// Abstract interface for authentication
abstract class AuthDataSource extends RemoteDataSource {
  Future<AuthResponse> login(String phone, String password);
  Future<AuthResponse> register(RegisterRequest request);
  Future<void> verifyOtp(String phone, String otp);
  Future<void> logout();
  Future<String?> refreshToken();
  Stream<User?> get authStateChanges;
}

/// Abstract interface for real-time data
abstract class RealtimeDataSource extends RemoteDataSource {
  Stream<T> subscribe<T>(String path, T Function(Map<String, dynamic>) fromJson);
  Future<void> set<T>(String path, Map<String, dynamic> data);
  Future<void> update(String path, Map<String, dynamic> data);
  Future<void> delete(String path);
}

/// Abstract interface for location services
abstract class LocationDataSource extends RemoteDataSource {
  Future<void> updateLocation(String driverId, DriverLocation location);
  Stream<DriverLocation> streamDriverLocation(String driverId);
  Future<List<Driver>> getNearbyDrivers(Location center, double radiusKm);
}
```

### Firebase Implementation

```dart
// lib/infrastructure/firebase/firebase_auth_datasource.dart

class FirebaseAuthDataSource implements AuthDataSource {
  final FirebaseAuth _auth;
  final FirebaseFirestore _firestore;

  FirebaseAuthDataSource({
    required FirebaseAuth auth,
    required FirebaseFirestore firestore,
  }) : _auth = auth, _firestore = firestore;

  @override
  Future<void> initialize() async {
    // Firebase is initialized in main.dart
  }

  @override
  Future<AuthResponse> login(String phone, String password) async {
    try {
      // For phone auth, use verifyPhoneNumber flow
      // For email/password:
      final credential = await _auth.signInWithEmailAndPassword(
        email: phone, // or convert phone to email format
        password: password,
      );

      final user = credential.user!;
      final userData = await _firestore
          .collection('users')
          .doc(user.uid)
          .get();

      return AuthResponse(
        user: UserModel.fromFirestore(userData),
        token: await user.getIdToken(),
      );
    } on FirebaseAuthException catch (e) {
      throw AuthException(e.message ?? 'Authentication failed');
    }
  }

  @override
  Stream<User?> get authStateChanges {
    return _auth.authStateChanges().asyncMap((firebaseUser) async {
      if (firebaseUser == null) return null;

      final doc = await _firestore
          .collection('users')
          .doc(firebaseUser.uid)
          .get();

      return UserModel.fromFirestore(doc);
    });
  }

  // ... other implementations
}

// lib/infrastructure/firebase/firebase_location_datasource.dart

class FirebaseLocationDataSource implements LocationDataSource {
  final FirebaseFirestore _firestore;

  FirebaseLocationDataSource({required FirebaseFirestore firestore})
      : _firestore = firestore;

  @override
  Future<void> updateLocation(String driverId, DriverLocation location) async {
    await _firestore
        .collection('locations')
        .doc(driverId)
        .set(location.toJson());
  }

  @override
  Stream<DriverLocation> streamDriverLocation(String driverId) {
    return _firestore
        .collection('locations')
        .doc(driverId)
        .snapshots()
        .map((doc) => DriverLocation.fromJson(doc.data()!));
  }

  @override
  Future<List<Driver>> getNearbyDrivers(Location center, double radiusKm) async {
    // Using GeoFlutterFire for geospatial queries
    final geo = GeoFlutterFire();
    final centerPoint = geo.point(
      latitude: center.latitude,
      longitude: center.longitude,
    );

    final collectionRef = _firestore.collection('locations');

    final stream = geo.collection(collectionRef: collectionRef)
        .within(
          center: centerPoint,
          radius: radiusKm,
          field: 'position',
        );

    final docs = await stream.first;
    return docs
        .where((doc) => doc['status'] == 'online')
        .map((doc) => Driver.fromJson(doc.data() as Map<String, dynamic>))
        .toList();
  }
}
```

### REST API Implementation (Future)

```dart
// lib/infrastructure/rest/rest_auth_datasource.dart

class RestAuthDataSource implements AuthDataSource {
  final ApiClient _client;
  final SecureStorage _storage;

  RestAuthDataSource({
    required ApiClient client,
    required SecureStorage storage,
  }) : _client = client, _storage = storage;

  @override
  Future<void> initialize() async {
    // Load stored token
    final token = await _storage.read('access_token');
    if (token != null) {
      _client.setAuthToken(token);
    }
  }

  @override
  Future<AuthResponse> login(String phone, String password) async {
    final response = await _client.post('/auth/login', {
      'phone': phone,
      'password': password,
    });

    final authResponse = AuthResponse.fromJson(response.data);

    await _storage.write('access_token', authResponse.token);
    await _storage.write('refresh_token', authResponse.refreshToken);
    _client.setAuthToken(authResponse.token);

    return authResponse;
  }

  @override
  Stream<User?> get authStateChanges {
    // For REST, we use a behavior subject
    return _authStateController.stream;
  }

  // ... other implementations
}

// lib/infrastructure/rest/rest_location_datasource.dart

class RestLocationDataSource implements LocationDataSource {
  final ApiClient _client;
  final WebSocketClient _wsClient;

  RestLocationDataSource({
    required ApiClient client,
    required WebSocketClient wsClient,
  }) : _client = client, _wsClient = wsClient;

  @override
  Future<void> updateLocation(String driverId, DriverLocation location) async {
    // Send via WebSocket for real-time
    _wsClient.emit('location:update', location.toJson());

    // Also batch to REST API periodically
  }

  @override
  Stream<DriverLocation> streamDriverLocation(String driverId) {
    return _wsClient
        .on('driver:$driverId:location')
        .map((data) => DriverLocation.fromJson(data));
  }

  @override
  Future<List<Driver>> getNearbyDrivers(Location center, double radiusKm) async {
    final response = await _client.get('/drivers/nearby', queryParams: {
      'lat': center.latitude.toString(),
      'lng': center.longitude.toString(),
      'radius': radiusKm.toString(),
    });

    return (response.data['drivers'] as List)
        .map((json) => Driver.fromJson(json))
        .toList();
  }
}
```

### Dependency Injection Setup

```dart
// lib/injection_container.dart

import 'package:get_it/get_it.dart';

final sl = GetIt.instance;

Future<void> initDependencies() async {
  // Determine which backend to use from config
  final backendType = Environment.backendType;

  switch (backendType) {
    case BackendType.firebase:
      await _initFirebaseBackend();
      break;
    case BackendType.rest:
      await _initRestBackend();
      break;
  }

  // Register use cases (same for all backends)
  await _initUseCases();

  // Register BLoCs
  await _initBlocs();
}

Future<void> _initFirebaseBackend() async {
  // Firebase core
  await Firebase.initializeApp();

  sl.registerLazySingleton<FirebaseAuth>(() => FirebaseAuth.instance);
  sl.registerLazySingleton<FirebaseFirestore>(() => FirebaseFirestore.instance);

  // Data sources
  sl.registerLazySingleton<AuthDataSource>(
    () => FirebaseAuthDataSource(
      auth: sl(),
      firestore: sl(),
    ),
  );

  sl.registerLazySingleton<LocationDataSource>(
    () => FirebaseLocationDataSource(
      firestore: sl(),
    ),
  );

  sl.registerLazySingleton<TripDataSource>(
    () => FirebaseTripDataSource(
      firestore: sl(),
    ),
  );

  // Repositories
  sl.registerLazySingleton<AuthRepository>(
    () => AuthRepositoryImpl(
      remoteDataSource: sl(),
      localDataSource: sl(),
      networkInfo: sl(),
    ),
  );

  sl.registerLazySingleton<TripRepository>(
    () => TripRepositoryImpl(
      remoteDataSource: sl(),
      locationDataSource: sl(),
      networkInfo: sl(),
    ),
  );
}

Future<void> _initRestBackend() async {
  // HTTP Client
  sl.registerLazySingleton<ApiClient>(
    () => ApiClient(
      baseUrl: Environment.apiBaseUrl,
    ),
  );

  // WebSocket Client
  sl.registerLazySingleton<WebSocketClient>(
    () => WebSocketClient(
      url: Environment.wsUrl,
    ),
  );

  // Data sources
  sl.registerLazySingleton<AuthDataSource>(
    () => RestAuthDataSource(
      client: sl(),
      storage: sl(),
    ),
  );

  sl.registerLazySingleton<LocationDataSource>(
    () => RestLocationDataSource(
      client: sl(),
      wsClient: sl(),
    ),
  );

  // ... same repositories, they don't care about implementation
}

Future<void> _initUseCases() async {
  // Auth
  sl.registerLazySingleton(() => LoginUseCase(sl()));
  sl.registerLazySingleton(() => RegisterUseCase(sl()));
  sl.registerLazySingleton(() => LogoutUseCase(sl()));

  // Trip
  sl.registerLazySingleton(() => RequestTripUseCase(sl()));
  sl.registerLazySingleton(() => CancelTripUseCase(sl()));
  sl.registerLazySingleton(() => StreamTripUpdatesUseCase(sl()));
  sl.registerLazySingleton(() => GetFareEstimateUseCase(sl()));

  // Location
  sl.registerLazySingleton(() => UpdateLocationUseCase(sl()));
  sl.registerLazySingleton(() => GetNearbyDriversUseCase(sl()));
}

Future<void> _initBlocs() async {
  sl.registerFactory(
    () => AuthBloc(
      login: sl(),
      register: sl(),
      logout: sl(),
    ),
  );

  sl.registerFactory(
    () => TripBloc(
      requestTrip: sl(),
      cancelTrip: sl(),
      streamTripUpdates: sl(),
    ),
  );

  sl.registerFactory(
    () => LocationBloc(
      updateLocation: sl(),
      getNearbyDrivers: sl(),
    ),
  );
}
```

### Environment Configuration

```dart
// lib/config/env/environment.dart

enum BackendType { firebase, rest }

class Environment {
  static late BackendType backendType;
  static late String apiBaseUrl;
  static late String wsUrl;
  static late String mapsApiKey;

  static Future<void> initialize() async {
    // Load from .env file or compile-time constants
    const flavor = String.fromEnvironment('FLAVOR', defaultValue: 'firebase');

    switch (flavor) {
      case 'firebase':
        backendType = BackendType.firebase;
        break;
      case 'rest':
        backendType = BackendType.rest;
        apiBaseUrl = const String.fromEnvironment('API_URL');
        wsUrl = const String.fromEnvironment('WS_URL');
        break;
    }

    mapsApiKey = const String.fromEnvironment('MAPS_API_KEY');
  }
}
```

---

## Summary

This architecture provides:

1. **Scalable Multi-Tenant SaaS** - Each taxi company is isolated with customizable branding and pricing

2. **Flexible Backend** - Start with Firebase for rapid development, migrate to custom backend when needed

3. **Clean Architecture** - Separation of concerns with domain-driven design

4. **Real-Time Capabilities** - Live tracking, instant updates, efficient location streaming

5. **Comprehensive Features** - Full ride-sharing platform with wallet, ratings, fleet management

6. **SaaS Monetization** - Multiple pricing models for sustainable business

7. **Production-Ready** - Proper error handling, caching, offline support

## Next Steps

1. Set up Flutter project with folder structure
2. Implement core abstractions and DI
3. Build authentication module
4. Create booking flow with real-time tracking
5. Implement wallet and payment system
6. Build driver app features
7. Create dispatcher dashboard
8. Set up Firebase backend
9. Add analytics and monitoring
10. Prepare for production deployment
